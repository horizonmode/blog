---
title: Exporting Kubernetes Logs to BetterStack using FluentBit
date: '2025-05-30'
tags: ['linode', 'devops', 'kubernetes', 'logging', 'fluent-bit', 'betterstack']
draft: false
summary: Overview of how to export logs from Kubernetes to BetterStack using FluentBit.
---

![FluentBit](/static/images/logging_better.jpg)

Following on from my previous post on [Exporting Kubernetes Logs to Linode S3 using FluentBit](https://www.linode.com/blog/exporting-kubernetes-logs-to-linode-s3-using-fluentbit/),
we found that the logs were being exported to S3 but we had no way to query them or 
set up alerts based on the logs.
We wanted to minimise the cluster overhead of managing a full logging stack such as Grafana Loki,
so we decided to use [BetterStack](https://betterstack.com/) as a logging solution partially be
cause it integrates well with FluentBit and provides a free tier. We will 
continue to use Linode S3 for long-term storage of logs, but we will now forward error logs to BetterStack for real-time monitoring and alerting.


## Overview

The architecture is shown below. Kubernetes by default rotates logs based on file size. 
Our aim is to export these logs now to BetterStack. BetterStack's free tier allows us to store logs for 3 days,
up to 3GB in size. Because of this, we decided to only forward error logs to BetterStack.

![Logging Architecture](/static/images/logging_architecture_better.png)

## Kubernetes Logging

Kubernetes default behaviour is defined [here](https://kubernetes.io/docs/concepts/cluster-administration/logging/). 
Kubernetes logs and application logs are stored via the underlying container runtime on each Node.
The kubelet is responsible for rotating container logs and managing the logging directory structure.
The kubelet sends this information to the container runtime (using CRI), 
and the runtime writes the container logs to the given location.

These logs are rotated based on two environment variables: 

1. containerLogMaxSize (default 10Mi) 
2. containerLogMaxFiles (default 5)

These settings let you configure the maximum size for each log file and the maximum number of files allowed for each container respectively.
Crucially, using the command **kubectl logs** will only ever return the latest file. The others would need to be accessed directly.

Our requirement is to extend this functionality to make these logs persist for 30 days regardless of size. 

## FluentBit

[FluentBit](https://fluentbit.io/) is a logging and metrics processor and forwarder. It can connect 
to multiple sources, allows you to enrich and filter incoming data and forward to 
a range of destinations. It's focus is on performance and efficiency which 
suits situations where resources are limited. 

### Comparison to FluentD

My understanding is FluentBit is the next-generation version of FluentD, heavily optimised. FluentD 
supports a wider range of connectors. A full comparison is provided [here](https://docs.fluentbit.io/manual/about/fluentd-and-fluent-bit).

### Tail Plugin

The [tail](https://docs.fluentbit.io/manual/pipeline/inputs/tail) plugin allows you to monitor one or several text files.
We define an input block to leverage this plugin and point to log files generated by Kubernetes or Applications:

```yml:fluentbit.yaml
    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        Parser docker
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines On
```
### HTTP Output Plugin

The [http](https://docs.fluentbit.io/manual/pipeline/outputs/http) plugin allows you to forward 
logs to an HTTP endpoint. We will use this to forward logs to BetterStack.

```yml:fluentbit.yaml
     [OUTPUT]
        name    http
        match   *
        tls     On
        host    xxxx
        port    443
        uri     /fluentbit
        header  Authorization Bearer xxxx
        header  Content-Type application/msgpack
        format  msgpack
        retry_limit 5
```
### Deployment

Kubernetes logs for an application are stored on it's underlying node. This means we need to 
deploy FluentBit as a DaemonSet, ensuring an instance of FluentBit runs once on each node.

Here is an example deployment manifest: 

```yaml:deployment.yaml
aapiVersion: apps/v1
kind: DaemonSet
metadata:
  name: better-stack-logger
  namespace: logging
  labels:
    k8s-app: better-stack-logger
spec:
  selector:
    matchLabels:
      name: better-stack-logger
  template:
    metadata:
      labels:
        name: better-stack-logger
    spec:
      serviceAccountName: fluent-bit
      containers:
        - name: fluent-bit
          image: fluent/fluent-bit:3.0
          imagePullPolicy: Always
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlogpods
              mountPath: /var/log/pods
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
            - name: config
              mountPath: /fluent-bit/etc/
      terminationGracePeriodSeconds: 10
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlogpods
          hostPath:
            path: /var/log/pods
            type: ""
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
            type: ""
        - name: config
          configMap:
            name: better-stack-fluent-bit-config
      tolerations:
        - effect: NoSchedule
          operator: Exists

```

## BetterStack
[BetterStack](https://betterstack.com/) is a monitoring and alerting platform that provides a free tier for
log management. It allows you to collect, search, and analyze logs in real-time, making it suitable for monitoring applications and infrastructure.
BetterStack provides a simple HTTP endpoint to which you can send logs. It supports various formats, including JSON and MsgPack.

Betterstack supports FluentBit as a data source, allowing you to forward logs directly from FluentBit to BetterStack.
Their [documentation](https://betterstack.com/community/guides/logging/fluent-bit-explained/) provides a guide on how to set up FluentBit as a source.

Once configured, you can use the LiveTail feature to view logs in real-time, set up alerts based on log patterns, and create dashboards to visualize log data.
![BetterStack Portal](/static/images/betterstack.png)